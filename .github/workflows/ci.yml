# ðŸ”¥ ZyeutÃ© CI/CD Pipeline
# Comprehensive CI/CD pipeline with automated testing, quality checks, and deployment
# Optimized for self-hosted runner

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, master]
  pull_request:
    branches: [main, develop, master]
  workflow_dispatch:

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Limit permissions for security
permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # ============================================================================
  # Phase 1: Code Quality Checks
  # ============================================================================
  
  lint-and-format:
    name: ðŸ” Lint & Format Check
    runs-on: self-hosted
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸŽ¨ Check code formatting (Prettier)
        run: |
          if ! npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css,md}"; then
            echo "âŒ Code formatting issues found. Run 'npx prettier --write .' to fix."
            exit 1
          fi
        continue-on-error: true
      
      - name: ðŸ” Run ESLint
        run: npm run lint
        continue-on-error: true
  
  type-check:
    name: ðŸ“ TypeScript Type Check
    runs-on: self-hosted
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ“ Run TypeScript type checking
        run: npm run type-check
        continue-on-error: true

  # ============================================================================
  # Phase 2: Build & Test
  # ============================================================================
  
  build:
    name: ðŸ—ï¸ Build Project
    runs-on: self-hosted
    needs: [lint-and-format, type-check]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ—ï¸ Build production bundle
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: ðŸ“Š Check build output
        run: |
          echo "âœ… Build completed successfully!"
          echo "ðŸ“¦ Build directory contents:"
          ls -lh dist/
          echo ""
          echo "ðŸ“ Total build size:"
          du -sh dist/
      
      - name: ðŸ“¦ Check bundle size
        run: |
          SIZE_KB=$(du -sk dist | cut -f1)
          SIZE_MB=$(echo "scale=2; $SIZE_KB / 1024" | bc)
          echo "Bundle size: ${SIZE_MB} MB (${SIZE_KB} KB)"
          
          # Warn if bundle exceeds 1MB (1024 KB)
          if [ $SIZE_KB -gt 1024 ]; then
            echo "âš ï¸ Warning: Bundle size exceeds 1MB: ${SIZE_MB}MB"
            echo "Consider code splitting or lazy loading to reduce bundle size."
          else
            echo "âœ… Bundle size is within acceptable range."
          fi
      
      - name: ðŸ’¾ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ github.sha }}
          path: dist/
          retention-days: 7
          if-no-files-found: error
  
  test-unit:
    name: ðŸ§ª Unit Tests
    runs-on: self-hosted
    needs: [lint-and-format, type-check]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ§ª Run unit tests
        run: |
          if npm run test 2>/dev/null; then
            echo "âœ… Unit tests passed"
          else
            echo "âš ï¸ No unit tests configured yet"
            echo "Add test script to package.json and create test files"
          fi
        continue-on-error: true
      
      - name: ðŸ“Š Generate coverage report
        run: |
          if npm run test:coverage 2>/dev/null; then
            echo "âœ… Coverage report generated"
          else
            echo "âš ï¸ Coverage reporting not configured"
          fi
        continue-on-error: true

  # ============================================================================
  # Phase 3: Security Scanning
  # ============================================================================
  
  security-scan:
    name: ðŸ›¡ï¸ Security Scan
    runs-on: self-hosted
    needs: [build]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ” Run npm audit
        run: |
          echo "ðŸ” Scanning for dependency vulnerabilities..."
          if npm audit --audit-level=high; then
            echo "âœ… No high-severity vulnerabilities found"
          else
            echo "âš ï¸ High-severity vulnerabilities detected"
            echo "Run 'npm audit fix' to address issues"
          fi
        continue-on-error: true
      
      - name: ðŸ” Check for exposed secrets
        run: |
          echo "ðŸ” Scanning for exposed secrets in code..."
          
          # Check for common secret patterns
          if grep -r "VITE_SUPABASE_ANON_KEY.*eyJ" src/ 2>/dev/null; then
            echo "âŒ Exposed Supabase key found in source code!"
            exit 1
          fi
          
          if grep -r "sk_live_" src/ 2>/dev/null; then
            echo "âŒ Exposed Stripe live key found in source code!"
            exit 1
          fi
          
          if grep -r "sk_test_" src/ 2>/dev/null; then
            echo "âš ï¸ Warning: Stripe test key found in source code"
          fi
          
          echo "âœ… No exposed secrets detected"
        continue-on-error: true

  # ============================================================================
  # Phase 4: E2E Tests (Optional - only if configured)
  # ============================================================================
  
  test-e2e:
    name: ðŸŽ­ E2E Tests
    runs-on: self-hosted
    needs: [build]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸŽ­ Run E2E tests
        run: |
          if npm run test:e2e 2>/dev/null; then
            echo "âœ… E2E tests passed"
          else
            echo "âš ï¸ No E2E tests configured yet"
            echo "Install Playwright and add test:e2e script"
          fi
        continue-on-error: true

  # ============================================================================
  # Phase 5: Deployment
  # ============================================================================
  
  deploy-preview:
    name: ðŸš€ Deploy Preview (PR)
    runs-on: self-hosted
    needs: [build, security-scan, test-unit]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ github.sha }}
          path: dist/
      
      - name: ðŸ” Verify build artifacts
        run: |
          echo "ðŸ“¦ Verifying build artifacts..."
          ls -lh dist/
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ index.html not found in build artifacts"
            exit 1
          fi
          echo "âœ… Build artifacts verified"
      
      - name: ðŸš€ Deploy preview
        run: |
          echo "ðŸš€ Preview deployment for PR #${{ github.event.pull_request.number }}"
          echo "ðŸ“ Deployment would happen here with Netlify CLI"
          echo ""
          echo "To enable preview deployments:"
          echo "1. Add NETLIFY_AUTH_TOKEN to GitHub secrets"
          echo "2. Add NETLIFY_SITE_ID to GitHub secrets"
          echo "3. Uncomment deployment steps in workflow"
        # Uncomment to enable:
        # - name: Install Netlify CLI
        #   run: npm install -g netlify-cli
        # - name: Deploy to Netlify
        #   run: netlify deploy --dir=dist --message="PR #${{ github.event.pull_request.number }}"
        #   env:
        #     NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        #     NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
  
  deploy-staging:
    name: ðŸš€ Deploy Staging
    runs-on: self-hosted
    needs: [build, security-scan, test-unit]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ github.sha }}
          path: dist/
      
      - name: ðŸš€ Deploy to staging
        run: |
          echo "ðŸš€ Deploying to staging environment..."
          echo "ðŸ“ Deployment would happen here with Netlify CLI"
          echo ""
          echo "To enable staging deployment:"
          echo "1. Add NETLIFY_AUTH_TOKEN to GitHub secrets"
          echo "2. Add NETLIFY_SITE_ID_STAGING to GitHub secrets"
          echo "3. Uncomment deployment steps in workflow"
  
  deploy-production:
    name: ðŸš€ Deploy Production
    runs-on: self-hosted
    needs: [build, security-scan, test-unit, test-e2e]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    environment:
      name: production
      url: https://zyeute.netlify.app
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ github.sha }}
          path: dist/
      
      - name: ðŸš€ Deploy to production
        run: |
          echo "ðŸš€ Deploying to production..."
          echo "ðŸ“ Deployment would happen here with Netlify CLI"
          echo ""
          echo "To enable production deployment:"
          echo "1. Add NETLIFY_AUTH_TOKEN to GitHub secrets"
          echo "2. Add NETLIFY_SITE_ID to GitHub secrets"
          echo "3. Uncomment deployment steps in workflow"
          echo "4. Set up production environment in GitHub repository settings"
      
      - name: ðŸ“¢ Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Security scans passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Tests passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— Production URL: https://zyeute.netlify.app" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Summary Job
  # ============================================================================
  
  pipeline-summary:
    name: ðŸ“Š Pipeline Summary
    runs-on: self-hosted
    needs: [lint-and-format, type-check, build, test-unit, security-scan]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate summary
        run: |
          echo "## ðŸ”¥ ZyeutÃ© CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- Lint & Format: ${{ needs.lint-and-format.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Type Check: ${{ needs.type-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.test-unit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Build Info" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
